name: CI/CD Pipeline

on:
  push:
    branches:
      - main

jobs:
  terraform:
    runs-on: ubuntu-latest
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: us-east-1
    
    outputs:
      ec2_ip: ${{ steps.terraform_output.outputs.ec2_ip }}

    steps:
      - name: Checkout do cÃ³digo
        uses: actions/checkout@v3

      - name: Setup do Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.7
          terraform_wrapper: false  #  IMPORTANTE: Adicione esta linha!

      - name: Inicializar Terraform
        run: terraform init
        working-directory: terraform

      - name: Aplicar Terraform
        run: terraform apply -auto-approve
        working-directory: terraform
      
      - name: Instalar jq
        run: sudo apt-get install -y jq

      - name: Capturar IP pÃºblico da EC2
        id: terraform_output
        run: |
          echo "ğŸ” Obtendo output do Terraform..."
          
          # MÃ©todo 1: Usar JSON (mais confiÃ¡vel)
          terraform output -json > tf_output.json
          echo "ConteÃºdo do JSON:"
          cat tf_output.json
          
          # Extrair IP do JSON
          IP=$(jq -r '.ec2_public_ip.value' tf_output.json)
          
          # Se ainda nÃ£o conseguir, tentar mÃ©todo alternativo
          if [ -z "$IP" ] || [ "$IP" = "null" ]; then
            echo "âš ï¸ MÃ©todo JSON falhou, tentando mÃ©todo raw..."
            RAW=$(terraform output -raw ec2_public_ip)
            echo "Raw output: '$RAW'"
            
            # Extrair IP usando mÃºltiplos mÃ©todos
            if [[ $RAW =~ ([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}) ]]; then
              IP="${BASH_REMATCH[1]}"
            else
              IP=$(echo "$RAW" | grep -oE '[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+' | head -1)
            fi
          fi
          
          echo "âœ… IP extraÃ­do: '$IP'"
          
          # Validar formato do IP
          if [[ ! $IP =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
            echo "âŒ ERRO: IP invÃ¡lido extraÃ­do: $IP"
            exit 1
          fi
          
          echo "ec2_ip=$IP" >> $GITHUB_OUTPUT
          echo "ğŸ¯ IP salvo no output: $IP"
        working-directory: terraform

      - name: Debug do output
        run: |
          echo "ğŸ“¤ Outputs disponÃ­veis:"
          echo "ec2_ip: ${{ steps.terraform_output.outputs.ec2_ip }}"
          echo "GITHUB_OUTPUT:"
          cat $GITHUB_OUTPUT || true

  deploy:
    runs-on: ubuntu-latest
    needs: terraform
    env:
      EC2_IP: ${{ needs.terraform.outputs.ec2_ip }}

    steps:
      - name: Checkout do cÃ³digo
        uses: actions/checkout@v3

      - name: Exibir IP recebido do Terraform
        run: |
          echo "ğŸ” Verificando IP recebido..."
          echo "IP do needs: ${{ needs.terraform.outputs.ec2_ip }}"
          echo "VariÃ¡vel EC2_IP: $EC2_IP"
          
          if [ -z "$EC2_IP" ]; then
            echo "âŒ ERRO: EC2_IP estÃ¡ vazio!"
            echo "Debug dos outputs:"
            echo "needs.terraform.outputs:"
            echo "${{ toJSON(needs.terraform.outputs) }}"
            exit 1
          fi
          
          if [[ ! $EC2_IP =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ ERRO: Formato de IP invÃ¡lido: $EC2_IP"
            exit 1
          fi
          
          echo "âœ… IP vÃ¡lido recebido: $EC2_IP"

      - name: Criar chave SSH para acessar EC2
        run: |
          echo "ğŸ”‘ Criando chave SSH..."
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > id_rsa
          chmod 600 id_rsa
          
          # Verificar se a chave foi criada
          echo "ğŸ“„ Verificando chave:"
          ls -la id_rsa
          echo "ğŸ“ Primeiras linhas:"
          head -2 id_rsa

      - name: Testar conexÃ£o SSH
        run: |
          echo "ğŸ”Œ Testando conexÃ£o com a EC2..."
          IP="$EC2_IP"
          
          # Aguardar instÃ¢ncia ficar pronta
          echo "â³ Aguardando instÃ¢ncia ficar disponÃ­vel..."
          for i in {1..30}; do
            if timeout 5 nc -z $IP 22 2>/dev/null; then
              echo "âœ… Porta 22 estÃ¡ aberta"
              break
            else
              echo "Tentativa $i/30: SSH ainda nÃ£o disponÃ­vel..."
              sleep 5
            fi
          done
          
          # Testar conexÃ£o SSH
          echo "ğŸ”‘ Testando autenticaÃ§Ã£o SSH..."
          ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 -i id_rsa ubuntu@$IP "echo 'âœ… ConexÃ£o SSH bem sucedida!'" || {
            echo "âŒ Falha na conexÃ£o SSH"
            echo "ğŸ” Verifique:"
            echo "1. Se a chave SSH estÃ¡ correta"
            echo "2. Se o security group permite SSH (porta 22)"
            echo "3. Se o usuÃ¡rio Ã© 'ubuntu'"
            exit 1
          }

      # ğŸ”¥ğŸ”¥ğŸ”¥ PASSO CRÃTICO: INSTALAR DOCKER ANTES DO DEPLOY ğŸ”¥ğŸ”¥ğŸ”¥
      - name: Instalar Docker e Docker Compose na EC2
        run: |
          echo "ğŸ³ INSTALANDO DOCKER NA EC2..."
          IP="$EC2_IP"
          
          ssh -o StrictHostKeyChecking=no -i id_rsa ubuntu@$IP << 'EOF'
            echo "ğŸ“¦ Atualizando pacotes..."
            sudo apt-get update -y
            
            echo "ğŸ”§ Instalando Docker..."
            curl -fsSL https://get.docker.com | sudo bash
            
            echo "ğŸ”§ Instalando Docker Compose..."
            sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" \
              -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
            
            echo "ğŸ‘¥ Configurando permissÃµes..."
            sudo usermod -aG docker ubuntu
            
            echo "ğŸš€ Iniciando Docker..."
            sudo systemctl start docker
            sudo systemctl enable docker
            
            echo "âœ… Verificando instalaÃ§Ãµes..."
            sudo docker --version
            sudo docker-compose --version
            
            echo "ğŸ§ª Testando Docker..."
            sudo docker run --rm hello-world
          EOF

      - name: Verificar instalaÃ§Ã£o do Docker
        run: |
          echo "ğŸ” Verificando Docker instalado..."
          IP="$EC2_IP"
          
          ssh -o StrictHostKeyChecking=no -i id_rsa ubuntu@$IP "
            echo 'ğŸ³ Docker version:'
            docker --version 2>/dev/null || sudo docker --version
            
            echo 'ğŸ“¦ Docker Compose version:'
            docker-compose --version 2>/dev/null || sudo docker-compose --version || /usr/local/bin/docker-compose --version
            
            echo 'ğŸ‘¤ UsuÃ¡rio no grupo docker:'
            groups ubuntu | grep docker && echo 'âœ… UsuÃ¡rio no grupo docker' || echo 'âš ï¸ UsuÃ¡rio nÃ£o estÃ¡ no grupo docker'
          "

      - name: Copiar cÃ³digo para EC2
        run: |
          echo "ğŸ“¤ Copiando arquivos para EC2..."
          IP="$EC2_IP"

          rsync -avz \
          --exclude='.git' \
          --exclude='.github' \
          --exclude='terraform' \
          --exclude='*.pem' \
          --exclude='id_rsa' \
          --exclude='minha-chave' \
          --exclude='mykey' \
          --exclude='*.pub' \
          -e "ssh -o StrictHostKeyChecking=no -i id_rsa" \
          ./ ubuntu@$IP:/home/ubuntu/app

      - name: Deploy com Docker Compose
        run: |
          echo "ğŸš€ Executando deploy..."
          IP="$EC2_IP"
          
          ssh -o StrictHostKeyChecking=no -i id_rsa ubuntu@$IP << 'EOF'
            echo "ğŸ“‚ Acessando diretÃ³rio /home/ubuntu/app..."
            cd /home/ubuntu/app
            
            echo "ğŸ“‹ ConteÃºdo do diretÃ³rio:"
            ls -la
            
            echo "ğŸ³ Verificando Docker..."
            docker --version 2>/dev/null || sudo docker --version
            docker-compose --version 2>/dev/null || sudo docker-compose --version
            
            echo "ğŸ”¨ Parando containers existentes (se houver)..."
            sudo docker-compose down 2>/dev/null || true
            
            echo "ğŸ—ï¸ Construindo e iniciando containers..."
            sudo docker-compose up -d --build
            
            echo "â³ Aguardando containers iniciarem..."
            sleep 15
            
            echo "ğŸ“Š Status dos containers:"
            sudo docker-compose ps
            
            echo "ğŸ“ Logs da aplicaÃ§Ã£o:"
            sudo docker-compose logs --tail=30
            
            echo "ğŸŒ Testando aplicaÃ§Ã£o..."
            curl -f http://localhost:5000 && echo "âœ… AplicaÃ§Ã£o respondendo!" || echo "âš ï¸ AplicaÃ§Ã£o ainda nÃ£o estÃ¡ respondendo"
          EOF

      - name: Mostrar URL da aplicaÃ§Ã£o
        run: |
          echo "===================================================="
          echo "âœ… DEPLOY CONCLUÃDO COM SUCESSO!"
          echo ""
          echo "ğŸŒ A aplicaÃ§Ã£o estÃ¡ disponÃ­vel em:"
          echo "   http://$EC2_IP:5000"
          echo ""
          echo "ğŸ” Para verificar os logs:"
          echo "   ssh -i id_rsa ubuntu@$EC2_IP 'cd /home/ubuntu/app && sudo docker-compose logs -f'"
          echo "===================================================="