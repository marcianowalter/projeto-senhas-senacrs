name: CI/CD Pipeline

on:
  push:
    branches:
      - main

jobs:
  terraform:
    runs-on: ubuntu-latest
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: us-east-1
    
    outputs:
      ec2_ip: ${{ steps.terraform_output.outputs.ec2_ip }}

    steps:
      - name: Checkout do c√≥digo
        uses: actions/checkout@v3

      - name: Setup do Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.7
          terraform_wrapper: false

      - name: Inicializar Terraform
        run: terraform init
        working-directory: terraform

      - name: Aplicar Terraform
        run: terraform apply -auto-approve
        working-directory: terraform
      
      - name: Instalar jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Capturar IP p√∫blico da EC2
        id: terraform_output
        run: |
          cd terraform
          terraform output -json > tf_output.json
          IP=$(jq -r '.ec2_public_ip.value' tf_output.json)

          if [[ ! $IP =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "ERRO: IP inv√°lido: $IP"
            exit 1
          fi

          echo "ec2_ip=$IP" >> $GITHUB_OUTPUT
        shell: bash

  deploy:
    runs-on: ubuntu-latest
    needs: terraform
    env:
      EC2_IP: ${{ needs.terraform.outputs.ec2_ip }}

    steps:
      - name: Checkout do c√≥digo
        uses: actions/checkout@v3

      - name: Exibir IP recebido
        run: |
          echo "EC2_IP: $EC2_IP"
          if [[ -z "$EC2_IP" ]]; then 
            echo "ERRO: IP da EC2 n√£o recebido"
            exit 1
          fi

      - name: Criar chave SSH
        run: |
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > id_rsa
          chmod 600 id_rsa

      - name: Testar conex√£o SSH
        run: |
          for i in {1..30}; do
            if timeout 5 nc -z $EC2_IP 22; then
              echo "SSH est√° ativo na tentativa $i"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "ERRO: N√£o foi poss√≠vel conectar via SSH ap√≥s 30 tentativas"
              exit 1
            fi
            sleep 5
          done

      - name: Instalar Docker na EC2
        run: |
          ssh -o StrictHostKeyChecking=no \
              -o ConnectTimeout=30 \
              -o ServerAliveInterval=60 \
              -i id_rsa ubuntu@$EC2_IP << 'EOF'
            set -e
            echo "=== Configurando ambiente na EC2 ==="

            # Verificar sistema
            echo "Sistema: $(lsb_release -ds)"
            echo "Arquitetura: $(uname -m)"

            # Remover locks se existirem
            echo "1. Removendo locks do APT..."
            sudo rm -f /var/lib/apt/lists/lock 2>/dev/null || true
            sudo rm -f /var/lib/dpkg/lock 2>/dev/null || true
            sudo rm -f /var/lib/dpkg/lock-frontend 2>/dev/null || true
            sudo rm -f /var/cache/apt/archives/lock 2>/dev/null || true

            # Configurar locale sem pacote espec√≠fico
            echo "2. Configurando locale..."
            sudo apt-get install -y locales
            sudo locale-gen en_US.UTF-8
            export LC_ALL=en_US.UTF-8
            export LANG=en_US.UTF-8
            sudo update-locale LANG=en_US.UTF-8

            # Atualizar sistema de forma segura
            echo "3. Atualizando sistema..."
            sudo apt-get update -y
            
            # Primeiro upgrade b√°sico
            echo "4. Atualizando pacotes b√°sicos..."
            sudo apt-get upgrade -y --with-new-pkgs

            # Instalar depend√™ncias essenciais
            echo "5. Instalando depend√™ncias..."
            sudo apt-get install -y \
              apt-transport-https \
              ca-certificates \
              curl \
              gnupg \
              lsb-release \
              software-properties-common

            # Adicionar reposit√≥rio Docker
            echo "6. Configurando reposit√≥rio Docker..."
            
            # Criar diret√≥rio para chaves
            sudo install -m 0755 -d /etc/apt/keyrings
            
            # Baixar e adicionar chave GPG
            curl -fsSL https://download.docker.com/linux/ubuntu/gpg | \
              sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
            sudo chmod a+r /etc/apt/keyrings/docker.gpg

            # Adicionar reposit√≥rio
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
              $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

            # Atualizar ap√≥s adicionar reposit√≥rio
            echo "7. Atualizando APT com Docker..."
            sudo apt-get update -y

            # Instalar Docker
            echo "8. Instalando Docker Engine..."
            sudo apt-get install -y \
              docker-ce \
              docker-ce-cli \
              containerd.io \
              docker-buildx-plugin \
              docker-compose-plugin

            # Configurar Docker
            echo "9. Configurando Docker..."
            sudo systemctl enable docker
            sudo systemctl start docker
            
            # Adicionar usu√°rio ao grupo docker
            sudo usermod -aG docker ubuntu

            # Configurar uso imediato do grupo
            newgrp docker << END
            echo "10. Verificando instala√ß√£o..."
            docker --version
            docker compose version
            docker info --format 'Server Version: {{.ServerVersion}}'
            END

            echo "=== Docker instalado com sucesso ==="
          EOF

      - name: Copiar aplica√ß√£o para EC2
        run: |
          # Criar estrutura de diret√≥rios primeiro
          ssh -o StrictHostKeyChecking=no -i id_rsa ubuntu@$EC2_IP "mkdir -p /home/ubuntu/app"
          
          # Copiar arquivos
          rsync -avz \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='terraform' \
            --exclude='id_rsa' \
            --exclude='*.tfstate' \
            --exclude='*.tfstate.backup' \
            --exclude='.terraform' \
            --exclude='.terraform.lock.hcl' \
            -e "ssh -o StrictHostKeyChecking=no -i id_rsa" \
            ./ ubuntu@$EC2_IP:/home/ubuntu/app/

          # Dar permiss√µes
          ssh -o StrictHostKeyChecking=no -i id_rsa ubuntu@$EC2_IP "chmod -R 755 /home/ubuntu/app"

      - name: Executar Docker Compose
        run: |
          ssh -o StrictHostKeyChecking=no -i id_rsa ubuntu@$EC2_IP << 'EOF'
            cd /home/ubuntu/app
            
            echo "=== Iniciando deploy com Docker Compose ==="
            
            # Verificar se existe docker-compose.yml
            if [ ! -f "docker-compose.yml" ] && [ ! -f "docker-compose.yaml" ]; then
              echo "ERRO: Arquivo docker-compose.yml n√£o encontrado!"
              ls -la
              exit 1
            fi
            
            # Parar containers existentes
            echo "1. Parando containers anteriores..."
            docker compose down --remove-orphans 2>/dev/null || true
            
            # Build e up
            echo "2. Construindo e iniciando containers..."
            docker compose up -d --build
            
            # Aguardar aplica√ß√£o
            echo "3. Aguardando aplica√ß√£o ficar dispon√≠vel..."
            for i in {1..30}; do
              echo "Tentativa $i/30..."
              
              # Verificar se container est√° rodando
              if docker compose ps | grep -q "Up"; then
                # Tentar acessar a aplica√ß√£o
                if curl -s -f --max-time 5 http://localhost:5000 > /dev/null 2>&1; then
                  echo "‚úÖ Aplica√ß√£o est√° respondendo!"
                  break
                fi
              fi
              sleep 5
            done
            
            # Mostrar status
            echo "4. Status final dos containers:"
            docker compose ps
            
            # Mostrar logs se houver erro
            if ! curl -s --max-time 5 http://localhost:5000 > /dev/null 2>&1; then
              echo "‚ö†Ô∏è  Aplica√ß√£o pode n√£o estar respondendo. √öltimos logs:"
              docker compose logs --tail=100
            fi
          EOF

      - name: Testar aplica√ß√£o
        run: |
          echo "Testando aplica√ß√£o em http://$EC2_IP:5000..."
          
          for i in {1..10}; do
            echo "Tentativa $i/10..."
            if curl -s -f --max-time 10 http://$EC2_IP:5000; then
              echo "‚úÖ Aplica√ß√£o est√° respondendo!"
              exit 0
            fi
            sleep 5
          done
          
          echo "‚ö†Ô∏è  Aplica√ß√£o pode estar iniciando..."
          echo "Tente acessar manualmente: http://$EC2_IP:5000"

      - name: Mostrar informa√ß√µes finais
        run: |
          echo "========================================="
          echo "üöÄ DEPLOY FINALIZADO!"
          echo ""
          echo "üåê URL da aplica√ß√£o:"
          echo "   http://$EC2_IP:5000"
          echo ""
          echo "üîß IP da inst√¢ncia: $EC2_IP"
          echo "üìã Para acessar via SSH:"
          echo "   ssh -i id_rsa ubuntu@$EC2_IP"
          echo ""
          echo "üìä Para ver logs da aplica√ß√£o:"
          echo "   ssh -i id_rsa ubuntu@$EC2_IP 'cd /home/ubuntu/app && docker compose logs'"
          echo "========================================="