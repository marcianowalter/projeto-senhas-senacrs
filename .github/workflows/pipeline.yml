name: CI/CD Pipeline

on:
  push:
    branches:
      - main

jobs:
  terraform:
    runs-on: ubuntu-latest
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: us-east-1
    
    outputs:
      ec2_ip: ${{ steps.terraform_output.outputs.ec2_ip }}

    steps:
      - name: Checkout do código
        uses: actions/checkout@v3

      - name: Setup do Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.7
          terraform_wrapper: false

      - name: Inicializar Terraform
        run: terraform init
        working-directory: terraform

      - name: Aplicar Terraform
        run: terraform apply -auto-approve
        working-directory: terraform
      
      - name: Instalar jq
        run: sudo apt-get install -y jq

      - name: Capturar IP público da EC2
        id: terraform_output
        run: |
          terraform output -json > tf_output.json
          IP=$(jq -r '.ec2_public_ip.value' tf_output.json)

          if [[ ! $IP =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "ERRO: IP inválido: $IP"
            exit 1
          fi

          echo "ec2_ip=$IP" >> $GITHUB_OUTPUT
        working-directory: terraform

  deploy:
    runs-on: ubuntu-latest
    needs: terraform
    env:
      EC2_IP: ${{ needs.terraform.outputs.ec2_ip }}

    steps:
      - name: Checkout do código
        uses: actions/checkout@v3

      - name: Exibir IP recebido
        run: |
          echo "EC2_IP: $EC2_IP"
          if [[ -z "$EC2_IP" ]]; then exit 1; fi

      - name: Criar chave SSH
        run: |
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > id_rsa
          chmod 600 id_rsa

      - name: Testar SSH
        run: |
          IP="$EC2_IP"
          for i in {1..20}; do
            if timeout 5 nc -z $IP 22; then break; fi
            sleep 5
          done
          ssh -o StrictHostKeyChecking=no -i id_rsa ubuntu@$IP "echo OK"

      - name: Instalar Docker + Compose
        run: |
          IP="$EC2_IP"

          ssh -o StrictHostKeyChecking=no -i id_rsa ubuntu@$IP << 'EOF'
            set -e

            echo "Aguardando locks do APT..."
            while sudo fuser /var/lib/dpkg/lock >/dev/null 2>&1 \
               || sudo fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1 \
               || sudo fuser /var/lib/apt/lists/lock >/dev/null 2>&1 \
               || sudo fuser /var/cache/apt/archives/lock >/dev/null 2>&1; do
              sleep 3
            done

            echo "Atualizando sistema..."
            sudo apt-get update -y

            echo "Instalando dependências..."
            sudo apt-get install -y \
              apt-transport-https \
              ca-certificates \
              curl \
              gnupg \
              lsb-release \
              software-properties-common

            echo "Adicionando chave GPG do Docker..."
            sudo mkdir -p /etc/apt/keyrings
            curl -fsSL https://download.docker.com/linux/ubuntu/gpg \
              | sudo gpg --batch --yes --dearmor -o /etc/apt/keyrings/docker.gpg

            echo "Adicionando repositório Docker..."
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" \
              | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

            sudo apt-get update -y

            echo "Instalando Docker Engine..."
            sudo apt-get install -y docker-ce docker-ce-cli containerd.io

            echo "Aguardando Docker daemon..."
            for i in {1..15}; do
              if sudo docker info >/dev/null 2>&1; then break; fi
              sleep 2
            done

            echo "Instalando Docker Compose (plugin oficial)..."
            sudo apt-get install -y docker-compose-plugin

            echo "Verificando versões..."
            docker --version
            docker compose version

            sudo usermod -aG docker ubuntu
          EOF

      - name: Copiar código para EC2
        run: |
          IP="$EC2_IP"
          rsync -avz \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='terraform' \
            --exclude='id_rsa' \
            -e "ssh -o StrictHostKeyChecking=no -i id_rsa" \
            ./ ubuntu@$IP:/home/ubuntu/app

      - name: Deploy com Docker Compose
        run: |
          IP="$EC2_IP"

          ssh -o StrictHostKeyChecking=no -i id_rsa ubuntu@$IP << 'EOF'
            cd /home/ubuntu/app

            echo "Parando containers antigos..."
            docker compose down || true

            echo "Subindo aplicação..."
            docker compose up -d --build

            echo "Aguardando aplicação..."
            for i in {1..10}; do
              if curl -f http://localhost:5000; then break; fi
              sleep 5
            done

            docker compose ps
          EOF

      - name: Mostrar URL
        run: |
          echo "==============================================="
          echo "✅ DEPLOY FINALIZADO!"
          echo "Acesse: http://$EC2_IP:5000"
          echo "==============================================="
