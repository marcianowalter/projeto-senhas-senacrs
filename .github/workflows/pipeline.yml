name: CI/CD Pipeline

on:
  push:
    branches:
      - main

jobs:
  terraform:
    runs-on: ubuntu-latest
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: us-east-1
    
    outputs:
      ec2_ip: ${{ steps.terraform_output.outputs.ec2_ip }}

    steps:
      - name: Checkout do c√≥digo
        uses: actions/checkout@v3

      - name: Setup do Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.7
          terraform_wrapper: false

      - name: Inicializar Terraform
        run: terraform init
        working-directory: terraform

      - name: Aplicar Terraform
        run: terraform apply -auto-approve
        working-directory: terraform

      - name: Capturar IP p√∫blico da EC2
        id: terraform_output
        run: |
          terraform output -json > tf_output.json
          IP=$(jq -r '.ec2_public_ip.value' tf_output.json)
          echo "ec2_ip=$IP" >> $GITHUB_OUTPUT
        working-directory: terraform

  deploy:
    runs-on: ubuntu-latest
    needs: terraform
    env:
      EC2_IP: ${{ needs.terraform.outputs.ec2_ip }}

    steps:
      - name: Checkout do c√≥digo
        uses: actions/checkout@v3

      - name: Verificar IP recebido
        run: echo "IP recebido: $EC2_IP"

      - name: Criar chave SSH para acessar EC2
        run: |
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > id_rsa
          chmod 600 id_rsa

      - name: Testar conex√£o SSH
        run: |
          ssh -o StrictHostKeyChecking=no -i id_rsa ubuntu@$EC2_IP "echo '‚úÖ Conex√£o SSH OK'"

      - name: Instalar Docker na EC2
        run: |
          echo "üê≥ Instalando Docker na EC2..."
          ssh -o StrictHostKeyChecking=no -i id_rsa ubuntu@$EC2_IP << 'EOF'
            # Atualizar pacotes
            sudo apt-get update
            
            # Instalar depend√™ncias
            sudo apt-get install -y \
                ca-certificates \
                curl \
                gnupg \
                lsb-release
            
            # Adicionar chave GPG oficial do Docker
            sudo mkdir -p /etc/apt/keyrings
            curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
            
            # Configurar reposit√≥rio
            echo \
              "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
              $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
            
            # Instalar Docker Engine
            sudo apt-get update
            sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
            
            # Adicionar usu√°rio ubuntu ao grupo docker
            sudo usermod -aG docker ubuntu
            
            # Iniciar e habilitar Docker
            sudo systemctl start docker
            sudo systemctl enable docker
            
            # Instalar Docker Compose (vers√£o standalone - opcional)
            sudo curl -L "https://github.com/docker/compose/releases/download/v2.23.0/docker-compose-$(uname -s)-$(uname -m)" \
              -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
            
            # Verificar instala√ß√µes
            echo "‚úÖ Docker instalado:"
            docker --version
            echo "‚úÖ Docker Compose instalado:"
            docker-compose --version
            
            # Testar Docker
            sudo docker run hello-world
          EOF

      - name: Copiar c√≥digo para EC2
        run: |
          echo "üì§ Copiando arquivos para EC2..."
          # Copiar apenas o necess√°rio (excluir terraform e chaves)
          rsync -avz -e "ssh -o StrictHostKeyChecking=no -i id_rsa" \
            --exclude='terraform/' \
            --exclude='id_rsa' \
            --exclude='minha-chave*' \
            --exclude='mykey' \
            --exclude='.git/' \
            --exclude='.github/' \
            ./ ubuntu@$EC2_IP:/home/ubuntu/app/

      - name: Deploy com Docker Compose
        run: |
          echo "üöÄ Executando deploy..."
          ssh -o StrictHostKeyChecking=no -i id_rsa ubuntu@$EC2_IP << 'EOF'
            cd /home/ubuntu/app
            
            echo "üìã Conte√∫do do diret√≥rio:"
            ls -la
            
            echo "üê≥ Verificando Docker..."
            docker --version
            docker-compose --version
            
            echo "üî® Construindo e iniciando containers..."
            # Usar docker compose (plugin) ou docker-compose
            docker compose up -d --build || docker-compose up -d --build
            
            echo "‚è≥ Aguardando containers iniciarem..."
            sleep 10
            
            echo "üìä Status dos containers:"
            docker compose ps || docker-compose ps
            
            echo "üìù Logs da aplica√ß√£o:"
            docker compose logs --tail=20 || docker-compose logs --tail=20
            
            echo "üåê Verificando se aplica√ß√£o est√° respondendo..."
            curl -f http://localhost:5000 || echo "Aplica√ß√£o ainda iniciando..."
          EOF

      - name: Mostrar URL da aplica√ß√£o
        run: |
          echo "===================================================="
          echo "‚úÖ DEPLOY CONCLU√çDO COM SUCESSO!"
          echo ""
          echo "üåê A aplica√ß√£o est√° dispon√≠vel em:"
          echo "   http://$EC2_IP:5000"
          echo ""
          echo "üîç Para verificar os logs:"
          echo "   ssh -i id_rsa ubuntu@$EC2_IP 'cd /home/ubuntu/app && docker compose logs'"
          echo "===================================================="