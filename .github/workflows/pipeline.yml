name: CI/CD Pipeline

on:
  push:
    branches:
      - main

jobs:
  terraform:
    runs-on: ubuntu-latest
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: us-east-1
    
    outputs:
      ec2_ip: ${{ steps.terraform_output.outputs.ec2_ip }}

    steps:
      - name: Checkout do código
        uses: actions/checkout@v3

      - name: Setup do Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.7
          terraform_wrapper: false

      - name: Inicializar Terraform
        run: terraform init
        working-directory: terraform

      - name: Aplicar Terraform
        run: terraform apply -auto-approve
        working-directory: terraform
      
      - name: Instalar jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Capturar IP público da EC2
        id: terraform_output
        run: |
          cd terraform
          terraform output -json > tf_output.json
          IP=$(jq -r '.ec2_public_ip.value' tf_output.json)

          if [[ ! $IP =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "ERRO: IP inválido: $IP"
            exit 1
          fi

          echo "ec2_ip=$IP" >> $GITHUB_OUTPUT
        shell: bash

  deploy:
    runs-on: ubuntu-latest
    needs: terraform
    env:
      EC2_IP: ${{ needs.terraform.outputs.ec2_ip }}

    steps:
      - name: Checkout do código
        uses: actions/checkout@v3

      - name: Exibir IP recebido
        run: |
          echo "EC2_IP: $EC2_IP"
          if [[ -z "$EC2_IP" ]]; then 
            echo "ERRO: IP da EC2 não recebido"
            exit 1
          fi

      - name: Criar chave SSH
        run: |
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > id_rsa
          chmod 600 id_rsa

      - name: Testar conexão SSH
        run: |
          for i in {1..30}; do
            if timeout 5 nc -z $EC2_IP 22; then
              echo "SSH está ativo na tentativa $i"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "ERRO: Não foi possível conectar via SSH após 30 tentativas"
              exit 1
            fi
            sleep 5
          done

      - name: Instalar Docker na EC2
        run: |
          ssh -o StrictHostKeyChecking=no \
              -o ConnectTimeout=30 \
              -o ServerAliveInterval=60 \
              -i id_rsa ubuntu@$EC2_IP << 'EOF'
            set -e
            echo "=== Configurando ambiente na EC2 ==="

            # Verificar sistema
            echo "Sistema: $(lsb_release -ds)"
            echo "Arquitetura: $(uname -m)"

            # MATAR processos apt/dpkg que possam estar travados
            echo "1. Parando processos apt/dpkg..."
            sudo killall -9 apt-get apt dpkg 2>/dev/null || true
            sudo pkill -f "apt-get" 2>/dev/null || true
            sudo pkill -f "dpkg" 2>/dev/null || true
            sleep 3

            # Remover locks se existirem
            echo "2. Removendo locks do APT..."
            sudo rm -f /var/lib/apt/lists/lock 2>/dev/null || true
            sudo rm -f /var/lib/dpkg/lock 2>/dev/null || true
            sudo rm -f /var/lib/dpkg/lock-frontend 2>/dev/null || true
            sudo rm -f /var/cache/apt/archives/lock 2>/dev/null || true
            sudo rm -f /var/lib/apt/lists/*.lock 2>/dev/null || true
            sleep 2

            # Configurar dpkg para não usar frontend
            echo "3. Configurando dpkg..."
            echo 'DPkg::Lock {"";}' | sudo tee /etc/apt/apt.conf.d/99disable-lock
            echo 'DPkg::Options { "--force-confdef"; "--force-confold"; }' | sudo tee -a /etc/apt/apt.conf.d/99disable-lock

            # Configurar locale sem pacote específico
            echo "4. Configurando locale..."
            sudo DEBIAN_FRONTEND=noninteractive apt-get install -y locales 2>/dev/null || true
            sudo locale-gen en_US.UTF-8
            export LC_ALL=en_US.UTF-8
            export LANG=en_US.UTF-8
            sudo update-locale LANG=en_US.UTF-8 LC_ALL=en_US.UTF-8

            # Atualizar sistema de forma segura
            echo "5. Atualizando sistema (fase 1)..."
            sudo DEBIAN_FRONTEND=noninteractive apt-get update -y 2>&1 | grep -v "WARNING: apt does not have"

            # Instalar dependências essenciais SEM upgrade inicial
            echo "6. Instalando dependências básicas..."
            sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
              apt-transport-https \
              ca-certificates \
              curl \
              gnupg \
              lsb-release \
              software-properties-common 2>&1 | grep -v "WARNING: apt does not have"

            # Agora fazer upgrade seguro
            echo "7. Atualizando pacotes (upgrade seguro)..."
            sudo DEBIAN_FRONTEND=noninteractive apt-get upgrade -y -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" 2>&1 | grep -v "WARNING: apt does not have"

            # Adicionar repositório Docker
            echo "8. Configurando repositório Docker..."
            
            # Criar diretório para chaves
            sudo install -m 0755 -d /etc/apt/keyrings
            
            # Baixar e adicionar chave GPG
            curl -fsSL https://download.docker.com/linux/ubuntu/gpg | \
              sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
            sudo chmod a+r /etc/apt/keyrings/docker.gpg

            # Adicionar repositório
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
              $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

            # Atualizar após adicionar repositório
            echo "9. Atualizando APT com Docker..."
            sudo DEBIAN_FRONTEND=noninteractive apt-get update -y 2>&1 | grep -v "WARNING: apt does not have"

            # Instalar Docker
            echo "10. Instalando Docker Engine..."
            sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
              docker-ce \
              docker-ce-cli \
              containerd.io \
              docker-buildx-plugin \
              docker-compose-plugin 2>&1 | grep -v "WARNING: apt does not have"

            # Configurar Docker
            echo "11. Configurando Docker..."
            sudo systemctl enable docker
            sudo systemctl start docker
            
            # Adicionar usuário ao grupo docker
            sudo usermod -aG docker ubuntu

            # Configurar uso imediato do grupo
            echo "12. Verificando instalação..."
            docker --version
            docker compose version
            
            # Testar docker sem sudo
            sg docker -c "docker --version" 2>/dev/null || echo "Nota: Reinicie a sessão para usar docker sem sudo"

            echo "=== Docker instalado com sucesso ==="
          EOF

      - name: Copiar aplicação para EC2
        run: |
          # Criar estrutura de diretórios primeiro
          ssh -o StrictHostKeyChecking=no -i id_rsa ubuntu@$EC2_IP "mkdir -p /home/ubuntu/app"
          
          # Copiar arquivos
          rsync -avz \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='terraform' \
            --exclude='id_rsa' \
            --exclude='*.tfstate' \
            --exclude='*.tfstate.backup' \
            --exclude='.terraform' \
            --exclude='.terraform.lock.hcl' \
            -e "ssh -o StrictHostKeyChecking=no -i id_rsa" \
            ./ ubuntu@$EC2_IP:/home/ubuntu/app/

          # Dar permissões
          ssh -o StrictHostKeyChecking=no -i id_rsa ubuntu@$EC2_IP "chmod -R 755 /home/ubuntu/app"

      - name: Executar Docker Compose
        run: |
          ssh -o StrictHostKeyChecking=no -i id_rsa ubuntu@$EC2_IP << 'EOF'
            cd /home/ubuntu/app
            
            echo "=== Iniciando deploy com Docker Compose ==="
            
            # Verificar se existe docker-compose.yml
            if [ ! -f "docker-compose.yml" ] && [ ! -f "docker-compose.yaml" ]; then
              echo "ERRO: Arquivo docker-compose.yml não encontrado!"
              ls -la
              exit 1
            fi
            
            # Parar containers existentes
            echo "1. Parando containers anteriores..."
            docker compose down --remove-orphans 2>/dev/null || true
            
            # Build e up
            echo "2. Construindo e iniciando containers..."
            docker compose up -d --build
            
            # Aguardar aplicação
            echo "3. Aguardando aplicação ficar disponível..."
            for i in {1..30}; do
              echo "Tentativa $i/30..."
              
              # Verificar se container está rodando
              if docker compose ps | grep -q "Up"; then
                # Tentar acessar a aplicação
                if curl -s -f --max-time 5 http://localhost:5000 > /dev/null 2>&1; then
                  echo "Aplicação está respondendo!"
                  break
                fi
              fi
              sleep 5
            done
            
            # Mostrar status
            echo "4. Status final dos containers:"
            docker compose ps
            
            # Mostrar logs se houver erro
            if ! curl -s --max-time 5 http://localhost:5000 > /dev/null 2>&1; then
              echo "Aplicação pode não estar respondendo. Últimos logs:"
              docker compose logs --tail=100
            fi
          EOF

      - name: Testar aplicação
        run: |
          echo "Testando aplicação em http://$EC2_IP:5000..."
          
          for i in {1..10}; do
            echo "Tentativa $i/10..."
            if curl -s -f --max-time 10 http://$EC2_IP:5000; then
              echo "Aplicação está respondendo!"
              exit 0
            fi
            sleep 5
          done
          
          echo "Aplicação pode estar iniciando..."
          echo "Tente acessar manualmente: http://$EC2_IP:5000"

      - name: Mostrar informações finais
        run: |
          echo "========================================="
          echo "DEPLOY FINALIZADO !!"
          echo ""
          echo "URL da aplicação:"
          echo "   http://$EC2_IP:5000"
          echo ""
          echo "IP da instância: $EC2_IP"
          echo "Para acessar via SSH:"
          echo "   ssh -i id_rsa ubuntu@$EC2_IP"
          echo ""
          echo "Para ver logs da aplicação:"
          echo "   ssh -i id_rsa ubuntu@$EC2_IP 'cd /home/ubuntu/app && docker compose logs'"
          echo "========================================="
