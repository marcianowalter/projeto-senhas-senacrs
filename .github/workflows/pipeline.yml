name: CI/CD Pipeline

on:
  push:
    branches:
      - main

jobs:
  terraform:
    runs-on: ubuntu-latest
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: us-east-1
    
    outputs:
      ec2_ip: ${{ steps.terraform_output.outputs.ec2_ip }}

    steps:
      - name: Checkout do c√≥digo
        uses: actions/checkout@v3

      - name: Setup do Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.7
          terraform_wrapper: false

      - name: Inicializar Terraform
        run: terraform init
        working-directory: terraform

      - name: Aplicar Terraform
        run: terraform apply -auto-approve
        working-directory: terraform
      
      - name: Instalar jq
        run: sudo apt-get install -y jq

      - name: Capturar IP p√∫blico da EC2
        id: terraform_output
        run: |
          echo "Obtendo output do Terraform..."
          
          terraform output -json > tf_output.json
          IP=$(jq -r '.ec2_public_ip.value' tf_output.json)
          
          echo "IP extra√≠do: '$IP'"
          
          if [[ ! $IP =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
            echo "ERRO: IP inv√°lido extra√≠do: $IP"
            exit 1
          fi
          
          echo "ec2_ip=$IP" >> $GITHUB_OUTPUT
        working-directory: terraform

  deploy:
    runs-on: ubuntu-latest
    needs: terraform
    env:
      EC2_IP: ${{ needs.terraform.outputs.ec2_ip }}

    steps:
      - name: Checkout do c√≥digo
        uses: actions/checkout@v3

      - name: Exibir IP recebido do Terraform
        run: |
          echo "Verificando IP recebido..."
          echo "Vari√°vel EC2_IP: $EC2_IP"
          
          if [ -z "$EC2_IP" ]; then
            echo "ERRO: EC2_IP est√° vazio!"
            exit 1
          fi
          
          if [[ ! $EC2_IP =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "ERRO: Formato de IP inv√°lido: $EC2_IP"
            exit 1
          fi
          
          echo "IP v√°lido recebido: $EC2_IP"

      - name: Criar chave SSH para acessar EC2
        run: |
          echo "Criando chave SSH..."
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > id_rsa
          chmod 600 id_rsa

      - name: Testar conex√£o SSH
        run: |
          echo "üîå Testando conex√£o com a EC2..."
          IP="$EC2_IP"
          
          echo "‚è≥ Aguardando inst√¢ncia ficar dispon√≠vel..."
          for i in {1..20}; do
            if timeout 5 nc -z $IP 22 2>/dev/null; then
              echo "Porta 22 est√° aberta"
              break
            else
              echo "Tentativa $i/20: SSH ainda n√£o dispon√≠vel..."
              sleep 5
            fi
          done
          
          ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 -i id_rsa ubuntu@$IP "echo 'Conex√£o SSH bem sucedida!'"

      - name: Instalar Docker e Docker Compose na EC2
        run: |
          echo "INSTALANDO DOCKER NA EC2..."
          IP="$EC2_IP"
          
          ssh -o StrictHostKeyChecking=no -i id_rsa ubuntu@$IP << 'EOF'
            set -e

            echo "‚è≥ Aguardando libera√ß√£o de locks do APT..."
            while sudo fuser /var/lib/dpkg/lock >/dev/null 2>&1 \
               || sudo fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1 \
               || sudo fuser /var/lib/apt/lists/lock >/dev/null 2>&1 \
               || sudo fuser /var/cache/apt/archives/lock >/dev/null 2>&1; do
              echo "APT est√° ocupado... aguardando 3s"
              sleep 3
            done

            echo "Atualizando sistema..."
            sudo apt-get update -y

            echo "Instalando pacotes necess√°rios..."
            sudo apt-get install -y \
                apt-transport-https \
                ca-certificates \
                curl \
                gnupg \
                lsb-release \
                software-properties-common

            echo "Adicionando chave GPG do Docker..."
            sudo mkdir -p /etc/apt/keyrings
            curl -fsSL https://download.docker.com/linux/ubuntu/gpg \
              | sudo gpg --batch --yes --dearmor -o /etc/apt/keyrings/docker.gpg

            echo "Adicionando reposit√≥rio Docker..."
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | \
            sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

            echo "Instalando Docker Engine..."
            sudo apt-get update -y
            sudo apt-get install -y docker-ce docker-ce-cli containerd.io || true

            echo "‚è≥ Aguardando Docker daemon iniciar..."
            for i in {1..15}; do
              if sudo docker info >/dev/null 2>&1; then
                echo "‚úÖ Docker daemon est√° ativo!"
                break
              else
                echo "Tentativa $i/15: Docker ainda n√£o iniciou..."
                sleep 2
              fi
            done

            if ! sudo docker info >/dev/null 2>&1; then
              echo "‚ùå Docker n√£o iniciou ap√≥s 30 segundos."
              exit 1
            fi

            echo "Instalando Docker Compose..."
            sudo curl -L "https://github.com/docker/compose/releases/download/v2.23.0/docker-compose-$(uname -s)-$(uname -m)" \
              -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose

            echo "Criando grupo docker..."
            sudo groupadd docker 2>/dev/null || true

            echo "Adicionando usu√°rio ao grupo docker..."
            sudo usermod -aG docker ubuntu

            echo "Verificando instala√ß√µes..."
            sudo docker --version
            /usr/local/bin/docker-compose --version
          EOF

      - name: Configurar permiss√µes Docker sem sudo
        run: |
          echo "Configurando permiss√µes para usar Docker sem sudo..."
          IP="$EC2_IP"
          
          ssh -o StrictHostKeyChecking=no -i id_rsa ubuntu@$IP "
            sudo chown root:docker /var/run/docker.sock
            sudo chmod 666 /var/run/docker.sock
            sudo setfacl -m user:ubuntu:rw /var/run/docker.sock
            ls -la /var/run/docker.sock
          "

      - name: Copiar c√≥digo para EC2
        run: |
          echo "Copiando arquivos para EC2..."
          IP="$EC2_IP"

          rsync -avz \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='terraform' \
            --exclude='*.pem' \
            --exclude='id_rsa' \
            --exclude='minha-chave' \
            --exclude='mykey' \
            --exclude='*.pub' \
            -e "ssh -o StrictHostKeyChecking=no -i id_rsa" \
            ./ ubuntu@$IP:/home/ubuntu/app

      - name: Deploy com Docker Compose
        run: |
          echo "Executando deploy..."
          IP="$EC2_IP"
          
          ssh -o StrictHostKeyChecking=no -i id_rsa ubuntu@$IP << 'EOF'
            echo "Acessando diret√≥rio /home/ubuntu/app..."
            cd /home/ubuntu/app
            
            echo "Conte√∫do do diret√≥rio:"
            ls -la
            
            echo "Verificando Docker..."
            docker --version || sudo docker --version
            docker-compose --version || /usr/local/bin/docker-compose --version
            
            echo "Parando containers existentes..."
            docker-compose down 2>/dev/null || sudo docker-compose down 2>/dev/null || true
            
            echo "Construindo e iniciando containers..."
            docker-compose up -d --build || sudo docker-compose up -d --build
            
            echo "Aguardando containers iniciarem..."
            sleep 20
            
            echo "Status dos containers:"
            docker-compose ps || sudo docker-compose ps
            
            echo "Logs da aplica√ß√£o:"
            docker-compose logs --tail=30 || sudo docker-compose logs --tail=30
            
            echo "Testando aplica√ß√£o..."
            for i in {1..10}; do
              if curl -f http://localhost:5000 2>/dev/null; then
                echo "Aplica√ß√£o respondendo!"
                break
              else
                echo "Tentativa $i/10: Aguardando aplica√ß√£o..."
                sleep 5
              fi
            done
          EOF

      - name: Mostrar URL da aplica√ß√£o
        run: |
          echo "===================================================="
          echo "‚úÖ DEPLOY CONCLU√çDO COM SUCESSO!!!"
          echo ""
          echo "A aplica√ß√£o est√° dispon√≠vel em:"
          echo "   http://$EC2_IP:5000"
          echo ""
          echo "Para verificar os logs:"
          echo "   ssh -i id_rsa ubuntu@$EC2_IP 'cd /home/ubuntu/app && docker-compose logs -f'"
          echo "===================================================="
